<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AeroCam – Piloto</title>
<link rel="stylesheet" href="style.css">
<script src="/socket.io/socket.io.js"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBE6RpbjSqnMFVKT6SHrU4y_9drfNHM4WI&callback=initMap"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3>Mi estado</h3>
      <div class="row">
        <input id="acId" placeholder="AC-001" style="flex:1"/>
        <input id="acRadius" placeholder="Radio (m)" type="number" value="800" style="width:120px"/>
        <button id="publish" class="primary">Publicar</button>
      </div>
      <div class="small">Sugerido: 500 m – 1 km en ciudad (Mini 4 Pro, VLOS).</div>
    </div>

    <div class="card">
      <h3>Mapa de cobertura</h3>
      <div id="map"></div>
    </div>

    <div class="card">
      <h3>Solicitudes inmediatas</h3>
      <div id="list"></div>
    </div>

    <div class="card">
      <h3>Transmisión</h3>
      <video id="localVideo" autoplay playsinline muted style="width:100%;height:220px;background:#000;border-radius:8px"></video>
    </div>
  </div>

<script>
const socket = io();
let map, myMarker;
const CLIENT_ROLE = 'AEROCAM';
let CLIENT_ID = 'AC-' + Math.floor(Math.random()*100000);

function initMap(){
  map = new google.maps.Map(document.getElementById('map'), { center:{lat:-33.4489,lng:-70.6693}, zoom:14, mapTypeId:'roadmap' });
  myMarker = new google.maps.Marker({ position: map.getCenter(), map, draggable:true, title:'AeroCam' });

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      myMarker.setPosition(p);
      map.setCenter(p);
      socket.emit('position:update', { clientKey: CLIENT_ID, role: CLIENT_ROLE, id: CLIENT_ID, lat: p.lat, lon: p.lng, radius: Number(document.getElementById('acRadius').value || 800) });
    }, ()=>{});
    navigator.geolocation.watchPosition(pos=>{
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      myMarker.setPosition({lat, lng: lon});
      socket.emit('position:update', { clientKey: CLIENT_ID, role: CLIENT_ROLE, id: CLIENT_ID, lat, lon, radius: Number(document.getElementById('acRadius').value || 800) });
    }, ()=>{}, { enableHighAccuracy:true, maximumAge:2000 });
  }
}

document.getElementById('publish').onclick = async ()=>{
  const id = document.getElementById('acId').value || CLIENT_ID;
  CLIENT_ID = id;
  const p = myMarker.getPosition();
  const radius = Number(document.getElementById('acRadius').value) || 800;
  await fetch('/api/aerocam/upsert', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, name: id, lat: p.lat(), lon: p.lng(), radius, online:true }) });
  alert('Publicado: ' + id);
};

socket.on('requests:update', (all)=>{ const pending = all.filter(r=>r.type==='inmediata' && r.status==='pendiente'); const container = document.getElementById('list'); container.innerHTML = ''; pending.forEach(r=>{ const el = document.createElement('div'); el.style.border='1px solid rgba(255,255,255,0.03)'; el.style.padding='8px'; el.style.marginBottom='8px'; el.innerHTML = `<div style="font-weight:700">ID: ${r.id}</div><div class="small">Modo: ${r.mode}</div><div style="margin-top:6px"><button data-id="${r.id}">Aceptar</button></div>`; el.querySelector('button').onclick = ()=> accept(r.id); container.appendChild(el); }); });

async function accept(id){ const acId = document.getElementById('acId').value || CLIENT_ID; const res = await fetch('/api/request/'+id+'/accept', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ aerocamId: acId }) }); if(!res.ok) return alert('Error al aceptar'); const data = await res.json(); alert('Aceptada: ' + data.id); }

const otherMarkers = {};
const otherCircles = {};
socket.on('positions:update', list => {
  const keep = new Set();
  list.forEach(item => {
    const key = item.clientKey;
    keep.add(key);
    if (key === CLIENT_ID) return;
    if (!otherMarkers[key]) otherMarkers[key] = new google.maps.Marker({ position:{lat:item.lat,lng:item.lon}, map, title:item.id });
    else otherMarkers[key].setPosition({lat:item.lat,lng:item.lon});
    if (item.role === 'AEROCAM' && item.radius) {
      if (!otherCircles[key]) otherCircles[key] = new google.maps.Circle({ strokeColor:'#4ea8ff', strokeOpacity:0.6, strokeWeight:2, fillColor:'#7bdcff', fillOpacity:0.12, map, center:{lat:item.lat,lng:item.lon}, radius:item.radius });
      else { otherCircles[key].setCenter({lat:item.lat,lng:item.lon}); otherCircles[key].setRadius(item.radius); }
    } else {
      if (otherCircles[key]) { otherCircles[key].setMap(null); delete otherCircles[key]; }
    }
  });
  Object.keys(otherMarkers).forEach(k=>{ if(!keep.has(k)){ otherMarkers[k].setMap(null); delete otherMarkers[k]; } });
  Object.keys(otherCircles).forEach(k=>{ if(!keep.has(k)){ otherCircles[k].setMap(null); delete otherCircles[k]; } });
});
</script>
</body>
</html>
