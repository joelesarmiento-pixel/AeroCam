<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>AeroCam – Piloto</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#0b0f14;color:#e9f0f4}
    .wrap{max-width:420px;margin:12px auto;padding:12px}
    .card{background:#121722;border-radius:12px;padding:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.04)}
    .row{display:flex;gap:8px}
    #map{width:100%;height:320px;border-radius:10px;overflow:hidden}
    input,button{padding:10px;border-radius:8px;border:none}
    button.primary{background:#1976d2;color:#fff;font-weight:700;cursor:pointer}
    .small{color:#7b8ca3;font-size:13px}
  </style>

  <script src="/socket.io/socket.io.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBE6RpbjSqnMFVKT6SHrU4y_9drfNHM4WI&callback=initMap"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3 style="margin:0 0 8px">Mi estado</h3>
      <div class="row">
        <input id="acId" placeholder="ID ej. AC-001" style="flex:1"/>
        <button id="publish" class="primary">Publicar</button>
      </div>
      <div class="small">Sugerido: cobertura 500 m – 1 km en ciudad (Mini 4 Pro, VLOS).</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Mapa de cobertura</h3>
      <div id="map"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Solicitudes inmediatas</h3>
      <div id="list"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Transmisión</h3>
      <video id="localVideo" autoplay playsinline muted style="width:100%;height:220px;background:#000;border-radius:8px"></video>
    </div>
  </div>

<script>
  const socket = io();
  let map, myMarker;
  const CLIENT_ROLE = 'AEROCAM';
  const CLIENT_ID = document.getElementById('acId') ? document.getElementById('acId').value || ('AC-'+Math.floor(Math.random()*10000)) : ('AC-'+Math.floor(Math.random()*10000));

  function initMap(){
    map = new google.maps.Map(document.getElementById('map'), { center:{lat:-33.4489,lng:-70.6693}, zoom:14, mapTypeId:'roadmap' });
    myMarker = new google.maps.Marker({ position: map.getCenter(), map, draggable:true, title:'AeroCam' });

    // publicar al mover el marker (manual) o publicar con botón "Publicar"
    myMarker.addListener('dragend', () => {
      const p = myMarker.getPosition();
      const radius = Number(document.getElementById('acRadius') ? document.getElementById('acRadius').value : 800) || 800;
      socket.emit('position:update', { clientId: CLIENT_ID, role: CLIENT_ROLE, id: CLIENT_ID, lat: p.lat(), lon: p.lng(), radius });
    });
  }

  // Botón publicar
  document.getElementById('publish').onclick = async () => {
    // asegúrate de que acId esté seteado
    const id = document.getElementById('acId').value || CLIENT_ID;
    const p = myMarker.getPosition();
    const radius = Number(document.getElementById('acRadius').value) || 800;
    socket.emit('position:update', { clientId: id, role: CLIENT_ROLE, id, lat: p.lat(), lon: p.lng(), radius });
    alert('Estado publicado');
  };

  // Recibir posiciones (mismo manejo que usuario)
  const otherMarkers = {};
  const otherCircles = {};

  socket.on('positions:update', list => {
    const keep = new Set();
    list.forEach(item => {
      const key = item.clientKey;
      keep.add(key);
      if (key === (document.getElementById('acId').value || CLIENT_ID)) return; // no dibujar tu propio 'otro'
      // marcador
      if (!otherMarkers[key]) otherMarkers[key] = new google.maps.Marker({ position:{lat:item.lat,lng:item.lon}, map, title:item.id });
      else otherMarkers[key].setPosition({lat:item.lat,lng:item.lon});
      // si es AEROCAM dibujar su radio; si es VISIONARIO tal vez dibujar solo marcador
      if (item.role === 'AEROCAM' && item.radius) {
        if (!otherCircles[key]) otherCircles[key] = new google.maps.Circle({
          strokeColor: "#4ea8ff", fillColor:"#7bdcff", fillOpacity:0.12, strokeOpacity:0.6, strokeWeight:2, map,
          center:{lat:item.lat,lng:item.lon}, radius:item.radius
        });
        else { otherCircles[key].setCenter({lat:item.lat,lng:item.lon}); otherCircles[key].setRadius(item.radius); }
      } else {
        if (otherCircles[key]) { otherCircles[key].setMap(null); delete otherCircles[key]; }
      }
    });
    Object.keys(otherMarkers).forEach(k => { if (!keep.has(k)) { otherMarkers[k].setMap(null); delete otherMarkers[k]; }});
    Object.keys(otherCircles).forEach(k => { if (!keep.has(k)) { otherCircles[k].setMap(null); delete otherCircles[k]; }});
  });
</script>

</body>
</html>

